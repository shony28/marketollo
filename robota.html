<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
  body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    padding: 10px; 
    background: #f4f4f9; 
    margin: 0;
  }

  /* –°—Ç–∏–ª—ñ –¥–ª—è –µ–∫—Ä–∞–Ω—É –≤—Ö–æ–¥—É */
  #loginContainer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-align: center;
  }

  #loginContainer h1 {
    color: #333;
    margin-bottom: 30px;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å */
  #appContainer {
    display: none;
  }

  h2 { text-align: center; color: #333; margin: 20px 0; }

  /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞ */
  .filter-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 0.9em;
    color: #555;
  }

  /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ (Toggle Switch) */
  .switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
  }

  .switch input { 
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 20px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider { background-color: #2ecc71; }
  input:checked + .slider:before { transform: translateX(20px); }

  /* –ö–ª–∞—Å –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è */
  .hidden-task { display: none !important; }

  #userInfo {
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-width: 600px;
    margin: 20px auto;
  }

  #userInfo button {
    margin-top: 10px;
    padding: 8px 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #taskList { max-width: 600px; margin: 0 auto; }

  .task-card { 
    background: white; 
    padding: 16px; 
    margin-bottom: 12px; 
    border-radius: 12px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (min-width: 480px) {
    .task-card { flex-direction: row; justify-content: space-between; align-items: center; }
  }

  .task-info { flex: 1; }
  .task-info strong { font-size: 1.1em; color: #2c3e50; display: block; margin-bottom: 4px; }
  .task-info small { color: #7f8c8d; font-size: 0.9em; }

  .task-controls { 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    gap: 8px;
    width: 100%;
  }

  @media (min-width: 480px) {
    .task-controls { width: auto; }
  }

  select { 
    flex: 1;
    padding: 10px; 
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    font-size: 16px;
  }

  button { 
    padding: 10px 18px; 
    font-size: 16px; 
    font-weight: bold;
    cursor: pointer; 
    background: #2b2b2b; 
    color: white; 
    border: none; 
    border-radius: 8px;
    min-width: 60px;
    transition: background 0.2s;
  }

  button:active { background: #555; }

  .status-badge { 
    display: inline-block;
    margin-bottom: 8px;
    font-size: 0.75em; 
    padding: 4px 12px; 
    border-radius: 20px; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-badge.status-–Ω–æ–≤–µ { background-color: #3498db; color: white; }
  .status-badge.status-–ø—Ä–æ—Ü–µ—Å—ñ { background-color: #f7cb00; color: #2c3e50; }
  .status-badge.status-–ø–∞—É–∑–∞ { background-color: #f78600; color: white; }
  .status-badge.status-–≤–∏–∫–æ–Ω–∞–Ω–æ { background-color: #2ecc71; color: white; }

  #loader { text-align: center; padding: 20px; }
</style>
</head>
<body>

  <div id="loginContainer">
    <h1>üìã –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏</h1>
    <p style="color: #666; margin-bottom: 30px;">–£–≤—ñ–π–¥—ñ—Ç—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Google –∞–∫–∞—É–Ω—Ç–∞</p>
    <div id="g_id_onload"
      data-client_id="738653025538-325fmpgrd37ji1leusus42gacqaja040.apps.googleusercontent.com"
      data-callback="handleLogin"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin"></div>
  </div>

  <div id="appContainer">
    <div id="userInfo"></div>
    <h2>üìã –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è</h2>

<div class="filter-container" style="flex-wrap: wrap; gap: 15px;">
  <div>
    <span>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</span>
    <select id="sortOrder" onchange="saveSortSettings(); loadTasks();" style="padding: 5px; font-size: 14px; border-radius: 5px;">
      <option value="priority">–ó–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º (–î–∞—Ç–∞)</option>
      <option value="status">–ó–∞ —Å—Ç–∞—Ç—É—Å–æ–º</option>
    </select>
  </div>
  
  <div style="display: flex; align-items: center; gap: 8px;">
    <span>–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ</span>
    <label class="switch">
      <input type="checkbox" id="hideDoneToggle" onchange="applyFilter()">
      <span class="slider"></span>
    </label>
  </div>
</div>

    <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...</div>
    <div id="taskList"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx9jMxg5AjebLHF0z5NWJwYPISXejVYL2_uJ0mmVqFmhnM_9MAUoLaRjZQK6jSAbwfo/exec";
    let currentUserEmail = null;

    function handleLogin(response) {
        fetch(API_URL + "?action=login", {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ token: response.credential })
        })
        .then(r => r.json())
        .then(user => {
          if (user.status === 'success') {
            currentUserEmail = user.email;
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('userName', user.name);
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("appContainer").style.display = "block";
            document.getElementById("userInfo").innerHTML = `
              <strong>–ü—Ä–∏–≤—ñ—Ç, ${user.name}!</strong><br>
              <small>${user.email}</small><br>
              <button onclick="logout()">–í–∏–π—Ç–∏</button>
            `;
            loadTasks();
          } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: " + user.message);
          }
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:", err);
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");
        });
      }

    function logout() {
        currentUserEmail = null;
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userName');
        document.getElementById("loginContainer").style.display = "flex";
        document.getElementById("appContainer").style.display = "none";
        document.getElementById("taskList").innerHTML = "";
    }

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó —Å–µ—Å—ñ—ó —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
function checkSavedSession() {
    // 1. –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ localStorage
    const savedEmail = localStorage.getItem('userEmail');
    const savedName = localStorage.getItem('userName');
    
    // 2. –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω —Ñ—ñ–ª—å—Ç—Ä–∞ "–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ"
    const savedFilter = localStorage.getItem('hideDoneSettings');
    if (savedFilter !== null) {
        // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —Ä—è–¥–æ–∫ "true"/"false" –Ω–∞–∑–∞–¥ —É –±—É–ª–µ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è
        document.getElementById('hideDoneToggle').checked = (savedFilter === 'true');
    }

    // 3. –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π —Ä–µ–∂–∏–º —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
    const savedSort = localStorage.getItem('taskSortMode');
    if (savedSort !== null) {
        document.getElementById('sortOrder').value = savedSort;
    }
    
    // 4. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±—É–≤ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π, –Ω–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
    if (savedEmail && savedName) {
        currentUserEmail = savedEmail;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω, —Ö–æ–≤–∞—î–º–æ –µ–∫—Ä–∞–Ω –≤—Ö–æ–¥—É
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        document.getElementById("userInfo").innerHTML = `
            <strong>–ü—Ä–∏–≤—ñ—Ç, ${savedName}!</strong><br>
            <small>${savedEmail}</small><br>
            <button onclick="logout()">–í–∏–π—Ç–∏</button>
        `;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è (–ª–æ–≥—ñ–∫–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤–∂–µ –≤–±—É–¥–æ–≤–∞–Ω–∞ –≤ loadTasks)
        loadTasks();
    }
}

    window.addEventListener('DOMContentLoaded', checkSavedSession);

    // –§—É–Ω–∫—Ü—ñ—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞
      function applyFilter() {
        const hideDoneToggle = document.getElementById('hideDoneToggle');
        const hideDone = hideDoneToggle.checked;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±—Ä–∞—É–∑–µ—Ä
        localStorage.setItem('hideDoneSettings', hideDone);
        const tasks = document.querySelectorAll('.task-card');
        tasks.forEach(card => {
          const status = card.getAttribute('data-status');
          if (hideDone && status === '–í–∏–∫–æ–Ω–∞–Ω–æ') {
            card.classList.add('hidden-task');
          } else {
            card.classList.remove('hidden-task');
          }
        });
      }

    function loadTasks() {
  if (!currentUserEmail) return;

  const ssId = '1v6ZjZqiES45fG35yB3Z17chEoK0df5QSWfMJxOu096A'; 
  const gvizUrl = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json`;

  fetch(gvizUrl)
    .then(res => res.text())
    .then(data => {
      const json = JSON.parse(data.substring(47, data.length - 2));
      let rows = json.table.rows;
      const list = document.getElementById('taskList');
      document.getElementById('loader').style.display = 'none';
      list.innerHTML = '';

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —É–¥–æ–±–Ω—ã–π –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
      let tasks = rows.map((row, index) => ({
        row: index + 2,
        title:     row.c[1]  ? row.c[1].v  : '',
        priorityDate: row.c[6] ? new Date(row.c[6].v) : new Date(8640000000000000), // G (Column 7)
        worker:    row.c[5]  ? row.c[5].v  : '',
        status:    row.c[7]  ? row.c[7].v  : '',
        userEmail: row.c[23] ? row.c[23].v : ''
      })).filter(t => t.title && t.userEmail === currentUserEmail);

      const sortMode = document.getElementById('sortOrder').value;

      // –õ–æ–≥–∏–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      tasks.sort((a, b) => {
        // –ü—Ä–∞–≤–∏–ª–æ: "–í–∏–∫–æ–Ω–∞–Ω–æ" –≤—Å–µ–≥–¥–∞ –≤ —Å–∞–º–æ–º –Ω–∏–∑—É –ø—Ä–∏ –ª—é–±–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
        if (a.status === '–í–∏–∫–æ–Ω–∞–Ω–æ' && b.status !== '–í–∏–∫–æ–Ω–∞–Ω–æ') return 1;
        if (a.status !== '–í–∏–∫–æ–Ω–∞–Ω–æ' && b.status === '–í–∏–∫–æ–Ω–∞–Ω–æ') return -1;

        if (sortMode === 'priority') {
          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (G): –æ—Ç –º–µ–Ω—å—à–µ–π –∫ –±–æ–ª—å—à–µ–π
          return a.priorityDate - b.priorityDate;
        } else {
          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É: –í –ø—Ä–æ—Ü–µ—Å—ñ > –ü–∞—É–∑–∞ > –ù–æ–≤–µ > –í–∏–∫–æ–Ω–∞–Ω–æ
          const weights = { "–í –ø—Ä–æ—Ü–µ—Å—ñ": 1, "–ü–∞—É–∑–∞": 2, "–ù–æ–≤–µ": 3, "–í–∏–∫–æ–Ω–∞–Ω–æ": 4 };
          return (weights[a.status] || 99) - (weights[b.status] || 99);
        }
      });

      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
      if (tasks.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999;">–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å</p>';
      } else {
        tasks.forEach(task => {
          const div = document.createElement('div');
          div.className = 'task-card';
          div.setAttribute('data-status', task.status);
          div.innerHTML = `
            <div class="task-info">
              <span class="status-badge ${getStatusClass(task.status)}">${task.status}</span><br>
              <strong>${task.title}</strong>
              <small>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${task.worker || '–Ω–µ–º–∞—î'}</small>
            </div>
            <div class="task-controls">
              <select id="status-${task.row}">
                <option value="–ù–æ–≤–µ" ${task.status === '–ù–æ–≤–µ' ? 'selected' : ''}>–ù–æ–≤–µ</option>
                <option value="–í –ø—Ä–æ—Ü–µ—Å—ñ" ${task.status === '–í –ø—Ä–æ—Ü–µ—Å—ñ' ? 'selected' : ''}>–í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                <option value="–í–∏–∫–æ–Ω–∞–Ω–æ" ${task.status === '–í–∏–∫–æ–Ω–∞–Ω–æ' ? 'selected' : ''}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                <option value="–ü–∞—É–∑–∞" ${task.status === '–ü–∞—É–∑–∞' ? 'selected' : ''}>–ü–∞—É–∑–∞</option>
                <option value="–í–∏–¥–∞–ª–∏—Ç–∏">–í–∏–¥–∞–ª–∏—Ç–∏</option>
              </select>
              <button onclick="updateStatus(${task.row})">–û–Ω–æ–≤–∏—Ç–∏</button>
            </div>
          `;
          list.appendChild(div);
        });
      }
      applyFilter(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä "–°–∫—Ä—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ"
    });
}

    function updateStatus(row) {
      const btn = event.target;
      const select = document.getElementById('status-' + row);
      const newStatus = select.value;
      const card = select.closest('.task-card');

      btn.disabled = true;
      btn.innerText = "‚è≥";

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ row: row, status: newStatus, userEmail: currentUserEmail })
      })
      .then(res => res.json())
      .then(out => {
        if (out.result === "success") {
          // –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–≥—ñ–∫—É —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
          loadTasks();
        } else {
          alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + out.message);
          btn.disabled = false;
          btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏";
        }
      })
      .catch(err => {
        alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: " + err);
        btn.disabled = false;
        btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏";
      });
    }

    function getStatusClass(status) {
      switch(status) {
        case '–ù–æ–≤–µ': return 'status-–Ω–æ–≤–µ';
        case '–í –ø—Ä–æ—Ü–µ—Å—ñ': return 'status-–ø—Ä–æ—Ü–µ—Å—ñ';
        case '–ü–∞—É–∑–∞': return 'status-–ø–∞—É–∑–∞';
        case '–í–∏–∫–æ–Ω–∞–Ω–æ': return 'status-–≤–∏–∫–æ–Ω–∞–Ω–æ';
        default: return '';
      }
    }
  </script>
</body>
</html>
