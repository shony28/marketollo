<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
  body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    padding: 10px; 
    background: #f4f4f9; 
    margin: 0;
  }

  /* –°—Ç–∏–ª—ñ –¥–ª—è –µ–∫—Ä–∞–Ω—É –≤—Ö–æ–¥—É */
  #loginContainer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    text-align: center;
  }

  #loginContainer h1 {
    color: #333;
    margin-bottom: 30px;
  }

  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å */
  #appContainer {
    display: none;
  }

  h2 { text-align: center; color: #333; margin: 20px 0; }

  /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞ */
  .filter-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-size: 0.9em;
    color: #555;
  }

  /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ (Toggle Switch) */
  .switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
  }

  .switch input { 
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 20px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider { background-color: #2ecc71; }
  input:checked + .slider:before { transform: translateX(20px); }

  /* –ö–ª–∞—Å –¥–ª—è –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è */
  .hidden-task { display: none !important; }

  #userInfo {
    text-align: center;
    margin: 20px 0;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    max-width: 600px;
    margin: 20px auto;
  }

  #userInfo button {
    margin-top: 10px;
    padding: 8px 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  #taskList { max-width: 600px; margin: 0 auto; }

  .task-card { 
    background: white; 
    padding: 16px; 
    margin-bottom: 12px; 
    border-radius: 12px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (min-width: 480px) {
    .task-card { flex-direction: row; justify-content: space-between; align-items: center; }
  }

  .task-info { flex: 1; }
  .task-info strong { font-size: 1.1em; color: #2c3e50; display: block; margin-bottom: 4px; }
  .task-info small { color: #7f8c8d; font-size: 0.9em; }

  .task-controls { 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    gap: 8px;
    width: 100%;
  }

  @media (min-width: 480px) {
    .task-controls { width: auto; }
  }

  select { 
    flex: 1;
    padding: 10px; 
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #fff;
    font-size: 16px;
  }

  button { 
    padding: 10px 18px; 
    font-size: 16px; 
    font-weight: bold;
    cursor: pointer; 
    background: #2b2b2b; 
    color: white; 
    border: none; 
    border-radius: 8px;
    min-width: 60px;
    transition: background 0.2s;
  }

  button:active { background: #555; }

  .status-badge { 
    display: inline-block;
    margin-bottom: 8px;
    font-size: 0.75em; 
    padding: 4px 12px; 
    border-radius: 20px; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-badge.status-–Ω–æ–≤–µ { background-color: #3498db; color: white; }
  .status-badge.status-–ø—Ä–æ—Ü–µ—Å—ñ { background-color: #f7cb00; color: #2c3e50; }
  .status-badge.status-–ø–∞—É–∑–∞ { background-color: #f78600; color: white; }
  .status-badge.status-–≤–∏–∫–æ–Ω–∞–Ω–æ { background-color: #2ecc71; color: white; }

  #loader { text-align: center; padding: 20px; }
</style>
</head>
<body>

  <div id="loginContainer">
    <h1>üìã –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏</h1>
    <p style="color: #666; margin-bottom: 30px;">–£–≤—ñ–π–¥—ñ—Ç—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Google –∞–∫–∞—É–Ω—Ç–∞</p>
    <div id="g_id_onload"
      data-client_id="738653025538-325fmpgrd37ji1leusus42gacqaja040.apps.googleusercontent.com"
      data-callback="handleLogin"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin"></div>
  </div>

  <div id="appContainer">
    <div id="userInfo"></div>
    <h2>üìã –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è</h2>

    <div class="filter-container">
      <span>–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ</span>
      <label class="switch">
        <input type="checkbox" id="hideDoneToggle" onchange="applyFilter()">
        <span class="slider"></span>
      </label>
    </div>

    <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...</div>
    <div id="taskList"></div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx9jMxg5AjebLHF0z5NWJwYPISXejVYL2_uJ0mmVqFmhnM_9MAUoLaRjZQK6jSAbwfo/exec";
    let currentUserEmail = null;

    function handleLogin(response) {
        fetch(API_URL + "?action=login", {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({ token: response.credential })
        })
        .then(r => r.json())
        .then(user => {
          if (user.status === 'success') {
            currentUserEmail = user.email;
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('userName', user.name);
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("appContainer").style.display = "block";
            document.getElementById("userInfo").innerHTML = `
              <strong>–ü—Ä–∏–≤—ñ—Ç, ${user.name}!</strong><br>
              <small>${user.email}</small><br>
              <button onclick="logout()">–í–∏–π—Ç–∏</button>
            `;
            loadTasks();
          } else {
            alert("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: " + user.message);
          }
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:", err);
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");
        });
      }

    function logout() {
        currentUserEmail = null;
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userName');
        document.getElementById("loginContainer").style.display = "flex";
        document.getElementById("appContainer").style.display = "none";
        document.getElementById("taskList").innerHTML = "";
    }

    function checkSavedSession() {
        const savedEmail = localStorage.getItem('userEmail');
        const savedName = localStorage.getItem('userName');
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏–∑ –ø–∞–º—è—Ç–∏
        const savedFilter = localStorage.getItem('hideDoneSettings');
        if (savedFilter !== null) {
          document.getElementById('hideDoneToggle').checked = (savedFilter === 'true');
        }
        if (savedEmail && savedName) {
          currentUserEmail = savedEmail;
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("appContainer").style.display = "block";
          document.getElementById("userInfo").innerHTML = `
            <strong>–ü—Ä–∏–≤—ñ—Ç, ${savedName}!</strong><br>
            <small>${savedEmail}</small><br>
            <button onclick="logout()">–í–∏–π—Ç–∏</button>
          `;
          loadTasks();
        }
    }

    window.addEventListener('DOMContentLoaded', checkSavedSession);

    // –§—É–Ω–∫—Ü—ñ—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞
      function applyFilter() {
        const hideDoneToggle = document.getElementById('hideDoneToggle');
        const hideDone = hideDoneToggle.checked;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±—Ä–∞—É–∑–µ—Ä
        localStorage.setItem('hideDoneSettings', hideDone);
        const tasks = document.querySelectorAll('.task-card');
        tasks.forEach(card => {
          const status = card.getAttribute('data-status');
          if (hideDone && status === '–í–∏–∫–æ–Ω–∞–Ω–æ') {
            card.classList.add('hidden-task');
          } else {
            card.classList.remove('hidden-task');
          }
        });
      }

    function loadTasks() {
      if (!currentUserEmail) return;

      const ssId = '1v6ZjZqiES45fG35yB3Z17chEoK0df5QSWfMJxOu096A'; 
      const gvizUrl = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=out:json`;

      fetch(gvizUrl)
        .then(res => res.text())
        .then(data => {
          const json = JSON.parse(data.substring(47, data.length - 2));
          const rows = json.table.rows;
          const list = document.getElementById('taskList');
          const loader = document.getElementById('loader');
          loader.style.display = 'none';
          list.innerHTML = '';

          let hasVisibleTasks = false;

          rows.forEach((row, index) => {
            const task = {
              row: index + 2,
              title:     row.c[1]  ? row.c[1].v  : '',
              worker:    row.c[5]  ? row.c[5].v  : '',
              status:    row.c[7]  ? row.c[7].v  : '',
              userEmail: row.c[23] ? row.c[23].v : ''
            };

            if (!task.title || task.userEmail !== currentUserEmail) return;

            hasVisibleTasks = true;

            const div = document.createElement('div');
            div.className = 'task-card';
            // –î–æ–¥–∞—î–º–æ –∞—Ç—Ä–∏–±—É—Ç —Å—Ç–∞—Ç—É—Å—É –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
            div.setAttribute('data-status', task.status);
            
            div.innerHTML = `
              <div class="task-info">
                <span class="status-badge ${getStatusClass(task.status)}">${task.status}</span><br>
                <strong>${task.title}</strong>
                <small>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${task.worker || '–Ω–µ–º–∞—î'}</small>
              </div>
              <div class="task-controls">
                <select id="status-${task.row}">
                  <option value="–ù–æ–≤–µ" ${task.status === '–ù–æ–≤–µ' ? 'selected' : ''}>–ù–æ–≤–µ</option>
                  <option value="–í –ø—Ä–æ—Ü–µ—Å—ñ" ${task.status === '–í –ø—Ä–æ—Ü–µ—Å—ñ' ? 'selected' : ''}>–í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                  <option value="–í–∏–∫–æ–Ω–∞–Ω–æ" ${task.status === '–í–∏–∫–æ–Ω–∞–Ω–æ' ? 'selected' : ''}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                  <option value="–ü–∞—É–∑–∞" ${task.status === '–ü–∞—É–∑–∞' ? 'selected' : ''}>–ü–∞—É–∑–∞</option>
                  <option value="–í–∏–¥–∞–ª–∏—Ç–∏">–í–∏–¥–∞–ª–∏—Ç–∏</option>
                </select>
                <button onclick="updateStatus(${task.row})">–û–Ω–æ–≤–∏—Ç–∏</button>
              </div>
            `;
            list.appendChild(div);
          });

          if (!hasVisibleTasks) {
            list.innerHTML = '<p style="text-align: center; color: #999;">–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å</p>';
          }

          // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
          applyFilter();
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:", err);
          document.getElementById('loader').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö";
        });
    }

    function updateStatus(row) {
      const btn = event.target;
      const select = document.getElementById('status-' + row);
      const newStatus = select.value;
      const card = select.closest('.task-card');

      btn.disabled = true;
      btn.innerText = "‚è≥";

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ row: row, status: newStatus, userEmail: currentUserEmail })
      })
      .then(res => res.json())
      .then(out => {
        if (out.result === "success") {
          // –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ª–æ–≥—ñ–∫—É —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
          loadTasks();
        } else {
          alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + out.message);
          btn.disabled = false;
          btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏";
        }
      })
      .catch(err => {
        alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: " + err);
        btn.disabled = false;
        btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏";
      });
    }

    function getStatusClass(status) {
      switch(status) {
        case '–ù–æ–≤–µ': return 'status-–Ω–æ–≤–µ';
        case '–í –ø—Ä–æ—Ü–µ—Å—ñ': return 'status-–ø—Ä–æ—Ü–µ—Å—ñ';
        case '–ü–∞—É–∑–∞': return 'status-–ø–∞—É–∑–∞';
        case '–í–∏–∫–æ–Ω–∞–Ω–æ': return 'status-–≤–∏–∫–æ–Ω–∞–Ω–æ';
        default: return '';
      }
    }
  </script>
</body>
</html>
