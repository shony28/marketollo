<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* –í–∞—à—ñ —Å—Ç–∏–ª—ñ –∫–æ–ø—ñ—é—é—Ç—å—Å—è —Å—é–¥–∏ –±–µ–∑ –∑–º—ñ–Ω... */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 10px; background: #f4f4f9; margin: 0; }
    #loginContainer { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
    #appContainer { display: none; }
    h2 { text-align: center; color: #333; margin: 20px 0; }
    .filter-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 0.9em; color: #555; }
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2ecc71; }
    input:checked + .slider:before { transform: translateX(20px); }
    .hidden-task { display: none !important; }
    #userInfo { text-align: center; margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 20px auto; }
    #userInfo button { margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #taskList { max-width: 600px; margin: 0 auto; }
    .task-card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 12px; }
    @media (min-width: 480px) { .task-card { flex-direction: row; justify-content: space-between; align-items: center; } }
    .task-info { flex: 1; }
    .task-info strong { font-size: 1.1em; color: #2c3e50; display: block; margin-bottom: 4px; }
    .task-info small { color: #7f8c8d; font-size: 0.9em; }
    .task-controls { display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; }
    @media (min-width: 480px) { .task-controls { width: auto; } }
    select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; font-size: 16px; }
    button { padding: 10px 18px; font-size: 16px; font-weight: bold; cursor: pointer; background: #2b2b2b; color: white; border: none; border-radius: 8px; min-width: 60px; transition: background 0.2s; }
    button:active { background: #555; }
    .status-badge { display: inline-block; margin-bottom: 8px; font-size: 0.75em; padding: 4px 12px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-badge.status-–Ω–æ–≤–µ { background-color: #3498db; color: white; }
    .status-badge.status-–ø—Ä–æ—Ü–µ—Å—ñ { background-color: #f7cb00; color: #2c3e50; }
    .status-badge.status-–ø–∞—É–∑–∞ { background-color: #d9760099; color: white; }
    .status-badge.status-–≤–∏–∫–æ–Ω–∞–Ω–æ { background-color: #2ecc71; color: white; }
    #loader { text-align: center; padding: 20px; }
    /* –°—Ç–∏–ª—ñ –¥–ª—è —Ñ–æ—Ä–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è */
    #createForm { 
      display: none; 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
      max-width: 560px; 
      margin: 20px auto; 
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .btn-primary { background: #2ecc71; width: 100%; margin-top: 5px; }
    .btn-cancel { background: #95a5a6; width: 100%; margin-top: 5px; }
    .header-actions { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; padding: 0 10px; }
        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ */
    .task-card[data-status="–í –ø—Ä–æ—Ü–µ—Å—ñ"] {
      border-left: 5px solid #f7cb00; /* –ñ–µ–ª—Ç–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
      box-shadow: 0 4px 12px rgba(247, 203, 0, 0.2); /* –ú—è–≥–∫–æ–µ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
      background-color: #fffdf5; /* –ï–¥–≤–∞ –∑–∞–º–µ—Ç–Ω—ã–π —Ç–µ–ø–ª—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ —Ñ–æ–Ω–∞ */
      transform: scale(1.01); /* –õ–µ–≥–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞ */
      transition: all 0.3s ease;
    }

    #userInfo {
  display: flex;
  align-items: center;
  gap: 12px;
  text-align: left;
  padding: 12px 16px;
}

.user-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #e8e8e8;
  flex-shrink: 0;
  transition: transform 0.2s ease;
}

.user-avatar:hover {
  transform: scale(1.05);
}

.user-details {
  flex: 1;
  min-width: 0;
}

.user-details strong {
  display: block;
  font-size: 0.95em;
  color: #2c3e50;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-details small {
  color: #95a5a6;
  font-size: 0.78em;
}

.user-logout {
  margin-top: 0 !important;
  padding: 6px 12px !important;
  font-size: 13px !important;
  background: #f0f0f0 !important;
  color: #666 !important;
  border-radius: 6px !important;
  font-weight: normal !important;
}

.user-logout:hover {
  background: #dc3545 !important;
  color: white !important;
  transition: all 0.2s ease;
}
  </style>
</head>
<body>

  <div id="loginContainer">
    <h1>üìã –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏</h1>
    <p style="color: #666; margin-bottom: 30px;">–£–≤—ñ–π–¥—ñ—Ç—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Google –∞–∫–∞—É–Ω—Ç–∞</p>
    <div id="g_id_onload"
      data-client_id="738653025538-325fmpgrd37ji1leusus42gacqaja040.apps.googleusercontent.com"
      data-callback="handleLogin"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin"></div>
  </div>

  <div id="appContainer">
    <div id="userInfo"></div>
    <div id="deptAlerts"></div>
    <div class="header-actions">
      <h2>üìã –ú–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
      <button onclick="toggleCreateForm(true)" style="background: #2ecc71;">+ –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
    </div>

    <div id="createForm">
      <h3 style="margin-top:0">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è (col_TITLE)</label>
        <input type="text" id="newTitle" placeholder="–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏?">
      </div>
      <div class="form-group">
        <label>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å (col_WORKER)</label>
        <input type="text" id="newWorker" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è">
      </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (DD.MM.YYYY)</label>
          <input type="text" 
                 id="newDate" 
                 placeholder="13.02.2026" 
                 oninput="formatDateInput(this)" 
                 maxlength="10">
        </div>
      <button class="btn-cancel" onclick="toggleCreateForm(false)">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn-primary" id="saveTaskBtn" onclick="submitNewTask()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
      </div>

    <div class="filter-container" style="flex-wrap: wrap; gap: 15px;">
      <div>
        <span>–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</span>
          <select id="sortOrder" onchange="saveSortSettings(); loadTasks();" style="padding: 5px; font-size: 14px; border-radius: 5px;">
            <option value="default">–Ø–∫ —É —Ç–∞–±–ª–∏—Ü—ñ (–∑–∞ –ø–æ—Ä—è–¥–∫–æ–º)</option>
            <option value="priority">–ó–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º (–î–∞—Ç–∞)</option>
            <option value="status">–ó–∞ —Å—Ç–∞—Ç—É—Å–æ–º</option>
          </select>
      </div>
      
      <div style="display: flex; align-items: center; gap: 8px;">
        <span>–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ</span>
        <label class="switch">
          <input type="checkbox" id="hideDoneToggle" onchange="applyFilter()">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...</div>
    <div id="taskList"></div>
  </div>

  <a href="https://2828.pp.ua/robota/statistics" class="back-link">statistics</a>

  <script>
    // –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –º–∏–Ω—É—Ç)
    const AUTO_REFRESH_MINUTES = 10; 
    let refreshInterval = null;

    let deptConfigs = {};       // { deptName: { ssId, API_URL, ... } }
    let activeDept = null;      // null = –æ—Å–Ω–æ–≤–Ω–∏–π –≤—ñ–¥–¥—ñ–ª, –∞–±–æ –Ω–∞–∑–≤–∞ —ñ–Ω—à–æ–≥–æ
    let isOtherDeptLoaded = false; // –ü—Ä–∞–ø–æ—Ä–µ—Ü—å, —á–∏ –º–∏ –∑–∞—Ä–∞–∑ –¥–∏–≤–∏–º–æ—Å—å —ñ–Ω—à–∏–π –≤—ñ–¥–¥—ñ–ª
    let formConfig = []; // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    let currentOtherDeptName = ""; // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏–º–µ–º–æ –Ω–∞–∑–≤—É –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É (–Ω–∞–ø—Ä. "marketing")
    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ö–û–õ–û–ù–û–ö (–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –∑ TEST.js) ---
    // –í JS –º–∞—Å–∏–≤–∞—Ö —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—è –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 0, —Ç–æ–º—É –≤—ñ–¥–Ω—ñ–º–∞—î–º–æ 1 –≤—ñ–¥ –Ω–æ–º–µ—Ä—ñ–≤ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ
    const col_TITLE           = 2 - 1;   // B
    const col_PROJECT         = 3 - 1;   // C
    const col_KONTRAHENT      = 4 - 1;   // D
    const col_WORKER          = 6 - 1;   // F
    const col_DATE            = 7 - 1;   // G
    const col_STATUS          = 8 - 1;   // H
    const col_TASK_EMAIL      = 24 - 1;  // X

    const API_URL = "https://script.google.com/macros/s/AKfycbx9jMxg5AjebLHF0z5NWJwYPISXejVYL2_uJ0mmVqFmhnM_9MAUoLaRjZQK6jSAbwfo/exec";
    let currentUserEmail = null;

    // –†–µ—à—Ç–∞ –ª–æ–≥—ñ–∫–∏ handleLogin, logout, checkSavedSession –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è...
function handleLogin(response) {
    fetch(API_URL + "?action=login", {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ token: response.credential })
    })
    .then(r => r.json())
    .then(user => {
      if (user.status === 'success') {
        currentUserEmail = user.email;
        localStorage.setItem('userEmail', user.email);
        localStorage.setItem('userName', user.name);
        localStorage.setItem('userPicture', user.picture || ''); // ‚Üê –î–û–ë–ê–í–ò–¢–¨
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        document.getElementById("userInfo").innerHTML = `
          ${user.picture ? `<img src="${user.picture}" class="user-avatar" alt="avatar">` : ''}
          <div class="user-details">
            <strong>${user.name}</strong>
            <small>${user.email}</small>
          </div>
          <button class="user-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
        `;
        loadTasks();
        startAutoRefresh();
      } else {
        alert("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: " + user.message);
      }
    });
}
function logout() {
    currentUserEmail = null;
    if (refreshInterval) clearInterval(refreshInterval); // –ó—É–ø–∏–Ω—è—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userName');
    localStorage.removeItem('userPicture');
    document.getElementById("loginContainer").style.display = "flex";
    document.getElementById("appContainer").style.display = "none";
    document.getElementById("taskList").innerHTML = "";
}

function checkSavedSession() {
    const savedEmail = localStorage.getItem('userEmail');
    const savedName = localStorage.getItem('userName');
    const savedFilter = localStorage.getItem('hideDoneSettings');
    if (savedFilter !== null) document.getElementById('hideDoneToggle').checked = (savedFilter === 'true');
    const savedSort = localStorage.getItem('taskSortMode');
    if (savedSort !== null) document.getElementById('sortOrder').value = savedSort;
    
    if (savedEmail && savedName) {
        currentUserEmail = savedEmail;
        const savedPicture = localStorage.getItem('userPicture') || '';
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        document.getElementById("userInfo").innerHTML = `
            ${savedPicture ? `<img src="${savedPicture}" class="user-avatar" alt="avatar">` : ''}
            <div class="user-details">
              <strong>${savedName}</strong>
              <small>${savedEmail}</small>
            </div>
            <button class="user-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
        `;
        loadTasks();
        startAutoRefresh(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    }
}

    window.addEventListener('DOMContentLoaded', checkSavedSession);

    function applyFilter() {
      const hideDone = document.getElementById('hideDoneToggle').checked;
      localStorage.setItem('hideDoneSettings', hideDone);
      document.querySelectorAll('.task-card').forEach(card => {
        const status = card.getAttribute('data-status');
        (hideDone && status === '–í–∏–∫–æ–Ω–∞–Ω–æ') ? card.classList.add('hidden-task') : card.classList.remove('hidden-task');
      });
    }

    function saveSortSettings() {
      localStorage.setItem('taskSortMode', document.getElementById('sortOrder').value);
    }

    function loadTasks() {
  if (!currentUserEmail) return;

  if (!activeDept) {
    checkOtherDepartments(currentUserEmail);
  }

  const cfg = activeDept ? deptConfigs[activeDept] : null;
  const currentApiUrl = cfg ? cfg.API_URL : API_URL;

  fetch(currentApiUrl + "?action=getTasks")
    .then(res => res.json())
    .then(rows => {
      const list = document.getElementById('taskList');
      document.getElementById('loader').style.display = 'none';
      list.innerHTML = '';

      let tasks = rows.map(row => {
        // date –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —è–∫ "YYYY-MM-DD" –∞–±–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫
        let rawDate = null;
        if (row.date) {
          // new Date("YYYY-MM-DD") —Ç—Ä–∞–∫—Ç—É—î —è–∫ UTC, –¥–æ–¥–∞—î–º–æ T00:00 —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∑—Å—É–≤—É
          rawDate = new Date(row.date + 'T00:00:00');
        }

        return {
          row:          row.row,
          title:        row.title,
          project:      row.project,
          client:       row.client,
          worker:       row.worker,
          status:       row.status,
          userEmail:    row.userEmail,
          priorityDate: rawDate && !isNaN(rawDate) ? rawDate : new Date(2099, 11, 31)
        };
      }).filter(t => t.title && t.userEmail === currentUserEmail);

      const sortMode = document.getElementById('sortOrder').value;
      tasks.sort((a, b) => {
        if (a.status === '–í–∏–∫–æ–Ω–∞–Ω–æ' && b.status !== '–í–∏–∫–æ–Ω–∞–Ω–æ') return 1;
        if (a.status !== '–í–∏–∫–æ–Ω–∞–Ω–æ' && b.status === '–í–∏–∫–æ–Ω–∞–Ω–æ') return -1;
        if (sortMode === 'priority') return a.priorityDate - b.priorityDate;
        if (sortMode === 'status') {
          const weights = { "–í –ø—Ä–æ—Ü–µ—Å—ñ": 1, "–ü–∞—É–∑–∞": 2, "–ù–æ–≤–µ": 3, "–í–∏–∫–æ–Ω–∞–Ω–æ": 4 };
          return (weights[a.status] || 99) - (weights[b.status] || 99);
        }
        return a.row - b.row;
      });

      if (tasks.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999;">–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å</p>';
      } else {
        tasks.forEach(task => {
          const div = document.createElement('div');
          div.className = 'task-card';
          div.setAttribute('data-status', task.status);
          const dateString = task.priorityDate.getFullYear() === 2099
            ? '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'
            : task.priorityDate.toLocaleDateString('uk-UA');
          div.innerHTML = `
            <div class="task-info">
              <span class="status-badge ${getStatusClass(task.status)}">${task.status}</span><br>
              <div style="font-size: 0.85em; color: #555; margin-bottom: 4px;">
                ${task.project ? `<strong>üìÅ ${task.project}</strong>` : ''}
                ${task.client ? `<span style="color:#777;">ü§ù ${task.client}</span>` : ''}
              </div>
              <strong>${task.title}</strong>
              <small>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å: ${task.worker || '–Ω–µ–º–∞—î'}</small>
              <small style="display: block; margin-top: 4px; color: #7f8c8d; font-weight: 500;">üìÖ –í–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ: ${dateString}</small>
            </div>
            <div class="task-controls">
              <select id="status-${task.row}">
                <option value="–ù–æ–≤–µ" ${task.status === '–ù–æ–≤–µ' ? 'selected' : ''}>–ù–æ–≤–µ</option>
                <option value="–í –ø—Ä–æ—Ü–µ—Å—ñ" ${task.status === '–í –ø—Ä–æ—Ü–µ—Å—ñ' ? 'selected' : ''}>–í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                <option value="–í–∏–∫–æ–Ω–∞–Ω–æ" ${task.status === '–í–∏–∫–æ–Ω–∞–Ω–æ' ? 'selected' : ''}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                <option value="–ü–∞—É–∑–∞" ${task.status === '–ü–∞—É–∑–∞' ? 'selected' : ''}>–ü–∞—É–∑–∞</option>
              </select>
              <button onclick="updateStatus(${task.row})">–û–Ω–æ–≤–∏—Ç–∏</button>
            </div>
          `;
          list.appendChild(div);
        });
      }
      applyFilter();
    })
    .catch(err => {
      console.error("–ü–æ–º–∏–ª–∫–∞:", err);
      document.getElementById('loader').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è";
    });
}

function updateStatus(row) {
      const btn = event.target;
      const select = document.getElementById('status-' + row);
      const newStatus = select.value;
      
      const cfg = activeDept ? deptConfigs[activeDept] : null;
      const currentApiUrl = cfg ? cfg.API_URL : API_URL;
      
      btn.disabled = true;
      btn.innerText = "‚è≥";
      
      fetch(currentApiUrl, {
        method: "POST",
        body: JSON.stringify({ row: row, status: newStatus, userEmail: currentUserEmail })
      })
      .then(res => res.json())
      .then(out => {
        if (out.result === "success") { 
            loadTasks(); 
        } else { 
            alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + out.message); 
            btn.disabled = false; 
            btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏"; 
        }
      })
      .catch(err => { 
          alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: " + err); 
          btn.disabled = false; 
          btn.innerText = "–û–Ω–æ–≤–∏—Ç–∏"; 
      });
}

    function getStatusClass(status) {
      switch(status) {
        case '–ù–æ–≤–µ': return 'status-–Ω–æ–≤–µ';
        case '–í –ø—Ä–æ—Ü–µ—Å—ñ': return 'status-–ø—Ä–æ—Ü–µ—Å—ñ';
        case '–ü–∞—É–∑–∞': return 'status-–ø–∞—É–∑–∞';
        case '–í–∏–∫–æ–Ω–∞–Ω–æ': return 'status-–≤–∏–∫–æ–Ω–∞–Ω–æ';
        default: return '';
      }
    }

      function toggleCreateForm(show) {
        const formContainer = document.getElementById('createForm');
        
        if (show) {
          // 1. –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –º–∏—Ç—Ç—î–≤–æ
          formContainer.style.display = 'block';
          // 2. –û—á–∏—â—É—î–º–æ —Å—Ç–∞—Ä–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —ñ –ø–æ–∫–∞–∑—É—î–º–æ –ª–æ–∞–¥–µ—Ä
          formContainer.innerHTML = `
            <h3 style="margin-top:0">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <div id="formLoader" style="text-align:center; padding: 20px;">
              <span style="color: #666;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó...</span>
            </div>
          `;

          // 3. –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ñ–æ–Ω–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–ª—ñ–≤
          fetch(API_URL)
            .then(res => res.json())
            .then(structure => {
              formConfig = structure;
              renderDynamicFields(structure); // –ú–∞–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –ø–æ–ª—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
            })
            .catch(err => {
              formContainer.innerHTML += `<p style="color:red">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${err}</p>
              <button class="btn-cancel" onclick="toggleCreateForm(false)">–ó–∞–∫—Ä–∏—Ç–∏</button>`;
            });
        } else {
          formContainer.style.display = 'none';
        }
      }

      function renderDynamicForm(fields) {
          const container = document.getElementById('createForm');
          // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∞–ª–µ –∑–∞–ª–∏—à–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ –∫–Ω–æ–ø–∫–∏ (–∞–±–æ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –≤—Å–µ)
          let html = '<h3 style="margin-top:0">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>';
          
          fields.forEach(field => {
            html += `<div class="form-group">
              <label>${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}</label>`;
            
            if (field.type === 'select') {
              html += `<input list="list-${field.col}" id="field-${field.col}" class="dynamic-field" placeholder="–û–±–µ—Ä—ñ—Ç—å –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å...">
                       <datalist id="list-${field.col}">
                         ${field.options.map(opt => `<option value="${opt}">`).join('')}
                       </datalist>`;
            } else if (field.type === 'date') {
              html += `<input type="text" id="field-${field.col}" class="dynamic-field" 
                        placeholder="DD.MM.YYYY" oninput="formatDateInput(this)" maxlength="10">`;
            } else {
              html += `<input type="text" id="field-${field.col}" class="dynamic-field" placeholder="${field.label}">`;
            }
            
            html += `</div>`;
          });

          html += `<button class="btn-cancel" onclick="toggleCreateForm(false)">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button class="btn-primary" onclick="submitNewTask()">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>`;
          
          container.innerHTML = html;
        }

        function renderDynamicFields(fields) {
          const container = document.getElementById('createForm');
          let html = '<h3 style="margin-top:0">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>';
          
          fields.forEach(field => {
            html += `<div class="form-group" style="margin-bottom: 12px;">
              <label style="display:block; font-weight:bold; margin-bottom:5px;">
                ${field.label} ${field.required ? '<span style="color:red">*</span>' : ''}
              </label>`;
            
            if (field.type === 'select') {
              html += `<input list="list-${field.col}" id="field-${field.col}" class="dynamic-field" 
                        placeholder="–û–±–µ—Ä—ñ—Ç—å –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å..." style="width:100%; padding:8px; box-sizing:border-box;">
                       <datalist id="list-${field.col}">
                         ${field.options.map(opt => `<option value="${opt}">`).join('')}
                       </datalist>`;
            } else if (field.type === 'date') {
              html += `<input type="text" id="field-${field.col}" class="dynamic-field" 
                        placeholder="–î–î.–ú–ú.–†–†–†–†" oninput="formatDateInput(this)" maxlength="10" 
                        style="width:100%; padding:8px; box-sizing:border-box;">`;
            } else {
              html += `<input type="text" id="field-${field.col}" class="dynamic-field" 
                        placeholder="${field.label}" style="width:100%; padding:8px; box-sizing:border-box;">`;
            }
            
            html += `</div>`;
          });

          html += `
            <div style="margin-top:20px; display:flex; gap:10px;">
              <button class="btn-cancel" onclick="toggleCreateForm(false)" style="flex:1">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              <button class="btn-primary" onclick="submitNewTask()" style="flex:1">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
              </div>
          `;
          
          container.innerHTML = html;
        }
        

function submitNewTask() {
  const btn = event.target;
  const payload = {
    userEmail: currentUserEmail,
    fields: {}
  };

  // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–∞ –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö
  for (let field of formConfig) {
    const input = document.getElementById(`field-${field.col}`);
    const value = input.value.trim();

    if (field.required && !value) {
      alert(`–ü–æ–ª–µ "${field.label}" —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º`);
      input.focus();
      return;
    }
    payload.fields[field.col] = value;
  }

  btn.disabled = true;
  btn.innerText = "‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";

  fetch(API_URL + "?action=create", {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(out => {
    if (out.result === "success") {
      toggleCreateForm(false);
      loadTasks();
    } else {
      alert("–ü–æ–º–∏–ª–∫–∞: " + out.message);
      btn.disabled = false;
      btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏";
    }
  })
  .catch(err => {
    alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
    btn.disabled = false;
    btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏";
  });
}

//—Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –º–∞—Å–∫–∏ –¥–∞—Ç–∏
    function formatDateInput(input) {
      // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å–µ, –∫—Ä—ñ–º —Ü–∏—Ñ—Ä
      let value = input.value.replace(/\D/g, '');
      
      // –§–æ—Ä–º—É—î–º–æ —Ä—è–¥–æ–∫ –∑ –∫—Ä–∞–ø–∫–∞–º–∏
      if (value.length > 2 && value.length <= 4) {
        value = value.slice(0, 2) + '.' + value.slice(2);
      } else if (value.length > 4) {
        value = value.slice(0, 2) + '.' + value.slice(2, 4) + '.' + value.slice(4, 8);
      }
      
      input.value = value;
    }

// —Ñ—É–Ω–∫—Ü—ñ—è —Ä–æ–±–∏—Ç—å –æ–∫—Ä–µ–º–∏–π –∑–∞–ø–∏—Ç –¥–æ –∞—Ä–∫—É—à–∞ users, —à—É–∫–∞—î —Ç–∞–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∫–æ–ª–æ–Ω–∫—É E.
function checkOtherDepartments(email) {
  Promise.all([
    fetch(API_URL + "?action=getUsers").then(r => r.json()),
    fetch(API_URL + "?action=getDepartments").then(r => r.json())
  ])
  .then(([usersData, deptsData]) => {
    // –ë—É–¥—É—î–º–æ —Å–ª–æ–≤–Ω–∏–∫ –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ –∑ –ª–∏—Å—Ç–∞ Departments
    deptConfigs = {};
    deptsData.forEach(d => {
      deptConfigs[d.name] = { ssId: d.ssId, API_URL: d.apiUrl };
    });

    // –®—É–∫–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const userRow = usersData.rows.find(r => r.email === email);
    if (!userRow) return;

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–µ–Ω –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª
    const alerts = [];
    usersData.headers.forEach(deptName => {
      const count = userRow[deptName] || 0;
      if (count > 0 && deptConfigs[deptName]) {
        alerts.push({ deptName, count });
      }
    });

    renderAllDeptAlerts(alerts);
  })
  .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤:", err));
}


function renderAllDeptAlerts(alerts) {
    document.querySelectorAll('.dept-alert').forEach(el => el.remove());

    if (activeDept) {
        renderActiveDeptAlert();
        return;
    }

    const alertsDiv = document.getElementById("deptAlerts"); 
    alerts.forEach(({ deptName, count }) => {
        const alertDiv = document.createElement("div");
        alertDiv.className = "dept-alert";
        alertDiv.style = "margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; color: #856404; font-size: 0.9em; text-align: center;";
        alertDiv.innerHTML = `
            <strong>‚ö†Ô∏è –£–≤–∞–≥–∞:</strong> –î–ª—è –≤–∞—Å —î –∑–∞–≤–¥–∞–Ω–Ω—è –≤ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ <b>${deptName}</b> (${count})
            <button onclick="switchDepartment('${deptName}')" style="margin-left:10px; padding:4px 8px; background:#f39c12; font-size:12px; border:none; border-radius:4px; color:white; cursor:pointer;">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        `;
        alertsDiv.appendChild(alertDiv); 
    });
}

function renderActiveDeptAlert() {
    const alertsDiv = document.getElementById("deptAlerts"); // ‚Üê –∏–∑–º–µ–Ω–∏—Ç—å
    const alertDiv = document.createElement("div");
    alertDiv.className = "dept-alert";
    alertDiv.style = "margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724; font-size: 0.9em; text-align: center;";
    alertDiv.innerHTML = `
        <strong>üìÇ –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª: ${activeDept}</strong>
        <button onclick="switchDepartment(null)" style="margin-left:10px; padding:4px 8px; background:#34495e; font-size:12px; border:none; border-radius:4px; color:white; cursor:pointer;">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞–∑–∞–¥</button>
    `;
    alertsDiv.appendChild(alertDiv); // ‚Üê –∏–∑–º–µ–Ω–∏—Ç—å
}

function switchDepartment(deptName) {
    if (deptName && !deptConfigs[deptName]) {
        alert("–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞");
        return;
    }
    activeDept = deptName;
    document.querySelectorAll('.dept-alert').forEach(el => el.remove());
    if (activeDept) renderActiveDeptAlert();
    document.getElementById('taskList').innerHTML = '';
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loader').innerText = activeDept ? "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..." : "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å...";
    loadTasks();
}

//—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–æ–º
function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    
    refreshInterval = setInterval(() => {
        console.log("–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å...");
        loadTasks();
    }, AUTO_REFRESH_MINUTES * 60 * 1000);
}


  </script>
</body>
</html>
