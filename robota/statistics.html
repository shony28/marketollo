<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–¥–∞–Ω—å</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .stats-container {
      display: grid;
      /* –ó–º—ñ–Ω–µ–Ω–æ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è 3-4 –∫–∞—Ä—Ç–æ–∫ */
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .chart-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 1.1em;
    }
    #loader {
      text-align: center;
      font-size: 1.2em;
      margin-top: 50px;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: #2b2b2b;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="header">
    <a href="index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</a>
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Å—É</h1>
    <p>–†–æ–∑–ø–æ–¥—ñ–ª —á–∞—Å—É (—É —Ö–≤–∏–ª–∏–Ω–∞—Ö) –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</p>
  </div>

  <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ —Ç–∞–±–ª–∏—Ü—ñ...</div>

  <div class="stats-container">
    <div class="chart-card">
      <div class="chart-title">–ó–∞ —Ç–∏–ø–∞–º–∏ —Ä–æ–±—ñ—Ç</div>
      <div id="chart_types" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">–ó–∞ –ø—Ä–æ—î–∫—Ç–∞–º–∏</div>
      <div id="chart_projects" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º</div>
      <div id="chart_clients" style="width: 100%; height: 350px;"></div>
    </div>
  </div>

  <script>
    // –Ü–Ω–¥–µ–∫—Å–∏ –∫–æ–ª–æ–Ω–æ–∫
    const COL_TYPE      = 0;  // A
    const COL_PROJECT   = 2;  // C
    const COL_CLIENT    = 3;  // D
    const COL_MINUTES   = 13; // N

    const SPREADSHEET_ID = '1v6ZjZqiES45fG35yB3Z17chEoK0df5QSWfMJxOu096A';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchData);

    function fetchData() {
      fetch(GVIZ_URL)
        .then(res => res.text())
        .then(text => {
          const jsonString = text.substring(47, text.length - 2);
          const data = JSON.parse(jsonString);
          processAndDraw(data.table.rows);
          document.getElementById('loader').style.display = 'none';
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞:", err);
          document.getElementById('loader').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.";
        });
    }

    function processAndDraw(rows) {
      const stats = {
        types: {},
        projects: {},
        clients: {}
      };

      rows.forEach(row => {
        const cells = row.c;
        const mins = (cells[COL_MINUTES] && cells[COL_MINUTES].v) ? Number(cells[COL_MINUTES].v) : 0;
        
        if (mins > 0) {
          // –¢–∏–ø–∏
          const type = (cells[COL_TYPE] && cells[COL_TYPE].v) ? cells[COL_TYPE].v : "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
          stats.types[type] = (stats.types[type] || 0) + mins;

          // –ü—Ä–æ—î–∫—Ç–∏
          const project = (cells[COL_PROJECT] && cells[COL_PROJECT].v) ? cells[COL_PROJECT].v : "–ë–µ–∑ –ø—Ä–æ—î–∫—Ç—É";
          stats.projects[project] = (stats.projects[project] || 0) + mins;

          // –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∏ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–ª—è –Ω–æ–≤–æ—ó –¥—ñ–∞–≥—Ä–∞–º–∏)
          const client = (cells[COL_CLIENT] && cells[COL_CLIENT].v) ? cells[COL_CLIENT].v : "–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç";
          stats.clients[client] = (stats.clients[client] || 0) + mins;
        }
      });

      drawPieChart('chart_types', '–¢–∏–ø', stats.types);
      drawPieChart('chart_projects', '–ü—Ä–æ—î–∫—Ç', stats.projects);
      drawPieChart('chart_clients', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', stats.clients);
    }

    function drawPieChart(elementId, label, dataObj) {
      const dataArray = [[label, '–•–≤–∏–ª–∏–Ω–∏']];
      for (const [key, value] of Object.entries(dataObj)) {
        dataArray.push([key, value]);
      }

      const data = google.visualization.arrayToDataTable(dataArray);
      const options = {
        pieHole: 0.4,
        chartArea: {width: '95%', height: '80%'},
        legend: {position: 'bottom', textStyle: {fontSize: 12}},
        // –Ø—Å–∫—Ä–∞–≤—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ñ–≤
        colors: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'],
        animation: { startup: true, duration: 800, easing: 'out' }
      };

      const chart = new google.visualization.PieChart(document.getElementById(elementId));
      chart.draw(data, options);
    }

    window.addEventListener('resize', () => {
        // –í–∏–∫–ª–∏–∫–∞—î–º–æ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤–∫—É –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –¥–æ –º–µ—Ä–µ–∂—ñ, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
        fetchData(); 
    });
  </script>
</body>
</html>
