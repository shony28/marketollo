<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Розширена статистика</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #f0f2f5; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
      gap: 20px; 
    }
    .chart-card { 
      background: white; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    h3 { color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .back-link { text-decoration: none; color: #007bff; font-weight: bold; }
  </style>
</head>
<body>

  <div class="header">
    <a href="index.html" class="back-link">← На головну</a>
    <h1>Аналітика ефективності</h1>
  </div>

  <div class="stats-grid">
    <div class="chart-card">
      <h3>Розподіл за контрагентом</h3>
      <div id="chart_pie_kontrahent" style="height: 300px;"></div>
    </div>

    <div class="chart-card">
      <h3>Розподіл за типом робіт</h3>
      <div id="chart_pie_types" style="height: 300px;"></div>
    </div>

    <div class="chart-card">
      <h3>Топ виконавців (хв)</h3>
      <div id="chart_bar_workers" style="height: 300px;"></div>
    </div>


    <div class="chart-card">
      <h3>Час за проєктами</h3>
      <div id="chart_bar_projects" style="height: 300px;"></div>
    </div>
  </div>

  <script>
    // Індекси колонок
    const COL_TYPE       = 0;  // A
    const COL_PROJECT    = 2;  // C
    const COL_KONTRAHENT = 3;  // D (4 - 1 = 3)
    const COL_WORKER     = 5;  // F
    const COL_DATE       = 6;  // G
    const COL_MINUTES    = 13; // N

    const SPREADSHEET_ID = '1v6ZjZqiES45fG35yB3Z17chEoK0df5QSWfMJxOu096A';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;

    google.charts.load('current', {'packages':['corechart', 'bar', 'line']});
    google.charts.setOnLoadCallback(fetchData);

    function fetchData() {
      fetch(GVIZ_URL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substring(47, text.length - 2));
          processData(json.table.rows);
        });
    }

    function processData(rows) {
      const stats = {
        types: {},
        workers: {},
        projects: {},
        days: {},
        kontrahents: {} // Об'єкт для контрагентів
      };

      rows.forEach(row => {
        const c = row.c;
        const mins = (c[COL_MINUTES] && c[COL_MINUTES].v) ? Number(c[COL_MINUTES].v) : 0;
        if (mins <= 0) return;

        // Групування
        const type = c[COL_TYPE]?.v || "Інше";
        const worker = c[COL_WORKER]?.v || "Невідомо";
        const project = c[COL_PROJECT]?.v || "Без назви";
        const kontr = c[COL_KONTRAHENT]?.v || "Не вказано";
        
        let dateKey = "Немає дати";
        if (c[COL_DATE] && c[COL_DATE].f) {
           dateKey = c[COL_DATE].f;
        }

        stats.types[type] = (stats.types[type] || 0) + mins;
        stats.workers[worker] = (stats.workers[worker] || 0) + mins;
        stats.projects[project] = (stats.projects[project] || 0) + mins;
        stats.days[dateKey] = (stats.days[dateKey] || 0) + mins;
        stats.kontrahents[kontr] = (stats.kontrahents[kontr] || 0) + mins;
      });

      drawCharts(stats);
    }

    function drawCharts(stats) {
      // 1. Pie Chart - Контрагенти
      const dataKontr = google.visualization.arrayToDataTable([
        ['Контрагент', 'Хвилини'], ...Object.entries(stats.kontrahents)
      ]);
      new google.visualization.PieChart(document.getElementById('chart_pie_kontrahent'))
          .draw(dataKontr, { pieHole: 0.4, chartArea: {width:'90%', height:'80%'} });

      // 2. Pie Chart - Типи
      const dataPie = google.visualization.arrayToDataTable([
        ['Тип', 'Хвилини'], ...Object.entries(stats.types)
      ]);
      new google.visualization.PieChart(document.getElementById('chart_pie_types'))
          .draw(dataPie, { pieHole: 0.4, chartArea: {width:'90%', height:'80%'} });

      // 3. Column Chart (Виконавці)
      const dataWorkers = google.visualization.arrayToDataTable([
        ['Виконавець', 'Хвилини', { role: 'style' }],
        ...Object.entries(stats.workers).map(([k, v]) => [k, v, '#3498db'])
      ]);
      new google.visualization.ColumnChart(document.getElementById('chart_bar_workers'))
          .draw(dataWorkers, { legend: 'none', chartArea: {width:'80%'} });

      // 4. Line Chart (Динаміка)
      const sortedDays = Object.entries(stats.days);
      const dataLine = google.visualization.arrayToDataTable([
        ['Дата', 'Завантаження'], ...sortedDays
      ]);
      new google.visualization.LineChart(document.getElementById('chart_line_days'))
          .draw(dataLine, { 
            curveType: 'function', 
            legend: { position: 'bottom' },
            hAxis: { title: 'Дата' },
            vAxis: { title: 'Хвилини' },
            pointSize: 7
          });

      // 5. Bar Chart (Проєкти)
      const dataProj = google.visualization.arrayToDataTable([
        ['Проєкт', 'Хвилини'], ...Object.entries(stats.projects)
      ]);
      new google.visualization.BarChart(document.getElementById('chart_bar_projects'))
          .draw(dataProj, { legend: 'none', colors: ['#2ecc71'] });
    }
  </script>
</body>
</html>
