<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–¥–∞–Ω—å</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .chart-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      min-height: 400px;
    }
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    #loader {
      text-align: center;
      font-size: 1.2em;
      margin-top: 50px;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 10px 20px;
      background: #2b2b2b;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div class="header">
    <a href="index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</a>
    <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Å—É</h1>
    <p>–†–æ–∑–ø–æ–¥—ñ–ª —á–∞—Å—É (—É —Ö–≤–∏–ª–∏–Ω–∞—Ö) –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</p>
  </div>

  <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ —Ç–∞–±–ª–∏—Ü—ñ...</div>

  <div class="stats-container">
    <div class="chart-card">
      <div class="chart-title">–ó–∞ —Ç–∏–ø–∞–º–∏ —Ä–æ–±—ñ—Ç</div>
      <div id="chart_types" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">–ó–∞ –ø—Ä–æ—î–∫—Ç–∞–º–∏</div>
      <div id="chart_projects" style="width: 100%; height: 350px;"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">–ó–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏</div>
      <div id="chart_clients" style="width: 100%; height: 350px;"></div>
    </div>
  </div>

  <script>
    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫ (0-indexed)
    const COL_TYPE      = 0;  // A: typeOfWork
    const COL_PROJECT   = 2;  // C: projectName
    const COL_CLIENT    = 3;  // D: kontrahent
    const COL_MINUTES   = 13; // N: col_TOTAL_MINUTES (14-—Ç–∞ –∫–æ–ª–æ–Ω–∫–∞)

    const SPREADSHEET_ID = '1v6ZjZqiES45fG35yB3Z17chEoK0df5QSWfMJxOu096A';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Google Charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchData);

    function fetchData() {
      fetch(GVIZ_URL)
        .then(res => res.text())
        .then(text => {
          // –ü–∞—Ä—Å–∏–º–æ JSON –∑ —Ñ–æ—Ä–º–∞—Ç—É gviz
          const jsonString = text.substring(47, text.length - 2);
          const data = JSON.parse(jsonString);
          const rows = data.table.rows;

          processAndDraw(rows);
          document.getElementById('loader').style.display = 'none';
        })
        .catch(err => {
          console.error("–ü–æ–º–∏–ª–∫–∞:", err);
          document.getElementById('loader').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.";
        });
    }

    function processAndDraw(rows) {
      // –û–±'—î–∫—Ç–∏ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö
      const stats = {
        types: {},
        projects: {},
        clients: {}
      };

      rows.forEach(row => {
        const cells = row.c;
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ö–≤–∏–ª–∏–Ω (–∫–æ–ª–æ–Ω–∫–∞ N)
        const mins = (cells[COL_MINUTES] && cells[COL_MINUTES].v) ? Number(cells[COL_MINUTES].v) : 0;
        
        if (mins > 0) {
          // –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –∑–∞ —Ç–∏–ø–æ–º
          const type = (cells[COL_TYPE] && cells[COL_TYPE].v) ? cells[COL_TYPE].v : "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
          stats.types[type] = (stats.types[type] || 0) + mins;

          // –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –∑–∞ –ø—Ä–æ—î–∫—Ç–æ–º
          const project = (cells[COL_PROJECT] && cells[COL_PROJECT].v) ? cells[COL_PROJECT].v : "–ë–µ–∑ –ø—Ä–æ—î–∫—Ç—É";
          stats.projects[project] = (stats.projects[project] || 0) + mins;

          // –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –∑–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º
          const client = (cells[COL_CLIENT] && cells[COL_CLIENT].v) ? cells[COL_CLIENT].v : "–ë–µ–∑ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞";
          stats.clients[client] = (stats.clients[client] || 0) + mins;
        }
      });

      drawPieChart('chart_types', '–¢–∏–ø —Ä–æ–±–æ—Ç–∏', stats.types);
      drawPieChart('chart_projects', '–ü—Ä–æ—î–∫—Ç', stats.projects);
      drawPieChart('chart_clients', '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç', stats.clients);
    }

    function drawPieChart(elementId, label, dataObj) {
      const dataArray = [[label, '–•–≤–∏–ª–∏–Ω–∏']];
      
      for (const [key, value] of Object.entries(dataObj)) {
        dataArray.push([key, value]);
      }

      const data = google.visualization.arrayToDataTable(dataArray);

      const options = {
        pieHole: 0.4, // –ó—Ä–æ–±–∏—Ç–∏ –¥—ñ–∞–≥—Ä–∞–º—É –∫—ñ–ª—å—Ü–µ–≤–æ—é (Donut chart)
        chartArea: {width: '90%', height: '80%'},
        legend: {position: 'bottom'},
        colors: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6', '#1abc9c', '#e67e22'],
        animation: {
          startup: true,
          duration: 1000,
          easing: 'out'
        }
      };

      const chart = new google.visualization.PieChart(document.getElementById(elementId));
      chart.draw(data, options);
    }

    // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—ñ
    window.addEventListener('resize', fetchData);
  </script>
</body>
</html>
